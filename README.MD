# ğŸ“Œ RepositÃ³rio de Consultas SQL - SAP HANA Business One

Bem-vindo ao repositÃ³rio de consultas SQL para o SAP HANA Business One! Aqui vocÃª encontrarÃ¡ uma coleÃ§Ã£o organizada de consultas para anÃ¡lise e extraÃ§Ã£o de dados, tanto de tabelas nativas quanto customizadas.

## ğŸ“‚ Estrutura do RepositÃ³rio

ğŸ“ **Compras**  
ğŸ“„ `C_Dev_NF_Entrada.SQL` - Notas fiscais de entrada (desenvolvimento)  
ğŸ“„ `D_NF_Entrada.SQL` - Detalhamento de notas fiscais de entrada  

ğŸ“ **ContÃ¡bil** *(Em construÃ§Ã£o)*  

ğŸ“ **Custom**  
ğŸ“„ `C_Itens.SQL` - Consulta de itens customizados  
ğŸ“„ `C_ValidaÃ§Ã£o.SQL` - ValidaÃ§Ã£o de dados customizados  
ğŸ“„ `U_Gatilho_Operador.SQL` - Gatilho de operador customizado  
ğŸ“„ `C_Transferencia_Matriz.SQL` - relatÃ³rio de transferÃªncia de mercadorias  

   ### ğŸ“Œ **ExplicaÃ§Ã£o Simplificada para UsuÃ¡rios || C_Transferencias_Matriz**  

   Esta consulta gera um **relatÃ³rio de transferÃªncia de mercadorias** entre diferentes filiais, mostrando as notas fiscais de saÃ­da (NS) e suas respectivas notas de entrada (NE) e devoluÃ§Ãµes de saÃ­da (DS), quando houver.  

   ---

   ## **ğŸ“Š O que este relatÃ³rio mostra?**
   - O **nÃºmero e a data** da Nota Fiscal de SaÃ­da (NS).
   - O **CNPJ da filial de origem** da mercadoria.
   - A **natureza da operaÃ§Ã£o** (neste caso, transferÃªncias).
   - O **valor total da nota**.
   - O **nÃºmero da Nota Fiscal** emitida.
   - Se houver, o **nÃºmero da Nota Fiscal de Entrada (NE)** correspondente.
   - Se houver, o **nÃºmero do Documento de DevoluÃ§Ã£o de SaÃ­da (DS)**.
   - O **usuÃ¡rio responsÃ¡vel** pela emissÃ£o da NS.
   - O **vendedor vinculado** Ã  transaÃ§Ã£o.

   ---

   ## **ğŸ“Œ Como funciona?**
   1. **Filtra apenas transferÃªncias** feitas pela **Matriz (CLJ001)**.
   2. **Seleciona apenas filiais especÃ­ficas** como origem da mercadoria.
   3. **Verifica se hÃ¡ uma Nota de Entrada (NE) correspondente**, exigindo que:
      - Para a filial **'17.642.282/0005-57'**, o fornecedor seja **'F001577'**.
      - Para outras filiais, sejam usados fornecedores especÃ­ficos.
   4. **Verifica se hÃ¡ uma devoluÃ§Ã£o de saÃ­da (DS)**, caso tenha ocorrido algum retorno de mercadoria.
   5. **Exibe as informaÃ§Ãµes organizadas** e ordenadas do **maior para o menor valor total**.

   ---

   ## **ğŸ“Œ O que isso significa na prÃ¡tica?**
   Este relatÃ³rio ajuda a **controlar a movimentaÃ§Ã£o de mercadorias entre filiais**, garantindo que:  
   âœ… Cada **Nota de SaÃ­da tenha uma Nota de Entrada correspondente** quando necessÃ¡rio.  
   âœ… **A empresa matriz (CLJ001) esteja sempre envolvida nas transferÃªncias**.  
   âœ… As **regras de relacionamento entre CNPJs e fornecedores** sejam respeitadas.  

   ---

   ğŸ“„ `D_Transverencias_Matriz.SQL` - Detalhamento de notas fiscais de entrada 
   ### ğŸ“Œ **ExplicaÃ§Ã£o da Consulta SQL || C_Transferencias_Matriz**
   Esta consulta estÃ¡ extraindo informaÃ§Ãµes de **documentos fiscais (Notas de SaÃ­da e Entrada)** no SAP Business One, garantindo que os relacionamentos entre as tabelas sejam feitos corretamente, com base em regras de negÃ³cio especÃ­ficas.

   ---

   ## **1ï¸âƒ£ Tabelas e Relacionamentos**
   A consulta busca informaÃ§Ãµes das seguintes tabelas:

   | Tabela  | DescriÃ§Ã£o |
   |---------|----------|
   | `OINV`  | Nota Fiscal de SaÃ­da (NS) |
   | `INV12` | InformaÃ§Ãµes de UtilizaÃ§Ã£o (Relacionada Ã  NS) |
   | `OUSG`  | Natureza da OperaÃ§Ã£o (Uso da Nota) |
   | `INV1`  | Itens da Nota Fiscal (Detalhes das linhas da NS) |
   | `OUSR`  | UsuÃ¡rios do sistema (Assinatura da NS) |
   | `OSLP`  | Vendedores (Relacionados Ã s notas) |
   | `OPCH`  | Notas de Entrada (NE) |
   | `ORIN`  | Documentos de DevoluÃ§Ã£o de SaÃ­da (DS) |

   ---

   ## **2ï¸âƒ£ SELECT: Campos Selecionados**
   A consulta retorna os seguintes campos:

   | Coluna | Significado |
   |--------|------------|
   | `NÂº Documento NS` | NÃºmero da Nota Fiscal de SaÃ­da |
   | `Data Documento NS` | Data da Nota Fiscal de SaÃ­da |
   | `CNPJ Origem` | CNPJ da filial que originou a nota |
   | `Natureza OperaÃ§Ã£o` | Uso da nota (Ex: TransferÃªncia de mercadoria) |
   | `Total Linha` | Soma dos valores das linhas da nota |
   | `NÂº NF` | NÃºmero do documento fiscal |
   | `NÂº Documento NE` | NÃºmero da Nota de Entrada correspondente |
   | `NÂº Documento DS` | NÃºmero do Documento de DevoluÃ§Ã£o de SaÃ­da |
   | `Abertura` | InformaÃ§Ã£o do campo de abertura (descriÃ§Ã£o) |
   | `Encerramento` | InformaÃ§Ã£o do campo de encerramento (descriÃ§Ã£o) |
   | `UsuÃ¡rio` | Nome do usuÃ¡rio que criou a NS |
   | `Vendedor` | Nome do vendedor responsÃ¡vel pela NS |

   ---

   ## **3ï¸âƒ£ INNER JOINS (Relacionamentos ObrigatÃ³rios)**
   Esses `JOINs` garantem que **apenas documentos vÃ¡lidos e existentes** sejam incluÃ­dos:

   ```sql
   INNER JOIN INV12 T1 ON T0."DocEntry" = T1."DocEntry"
   ```
   ğŸ“Œ Relaciona a Nota Fiscal (`OINV`) com sua **utilizaÃ§Ã£o fiscal** (`INV12`).

   ```sql
   INNER JOIN OUSG T2 ON T1."MainUsage" = T2."ID"
   ```
   ğŸ“Œ ObtÃ©m a **natureza da operaÃ§Ã£o**.

   ```sql
   INNER JOIN INV1 T3 ON T0."DocEntry" = T3."DocEntry"
   ```
   ğŸ“Œ Relaciona a nota com **os itens da NF**.

   ```sql
   INNER JOIN OUSR Z0 ON T0."UserSign" = Z0."USERID"
   ```
   ğŸ“Œ ObtÃ©m o **usuÃ¡rio que criou a nota**.

   ```sql
   INNER JOIN OSLP D1 ON T0."SlpCode" = D1."SlpCode"
   ```
   ğŸ“Œ ObtÃ©m o **vendedor** associado Ã  NF.

   ---

   ## **4ï¸âƒ£ LEFT JOINS (Relacionamentos Opcionais)**
   Os `LEFT JOINs` incluem informaÃ§Ãµes **se existirem**, sem eliminar registros caso nÃ£o haja correspondÃªncia.

   ### **ğŸ“Œ Relacionamento com Documentos de DevoluÃ§Ã£o (`ORIN`)**
   ```sql
   LEFT JOIN ORIN Z5 ON T0."Serial"  = Z5."Serial" AND (
         (T0."VATRegNum" = '17.642.282/0005-57' AND Z5."CardCode" = 'CLJ001') OR
         (T0."VATRegNum" = '17.642.282/0007-19' AND Z5."CardCode" = 'CLJ001') OR
         (T0."VATRegNum" = '17.642.282/0004-76' AND Z5."CardCode" = 'CLJ001') OR
         (T0."VATRegNum" = '17.642.282/0003-95' AND Z5."CardCode" = 'CLJ001') 
      )
   ```
   ğŸ“Œ **Relaciona Notas de SaÃ­da (`OINV`) com DevoluÃ§Ãµes de SaÃ­da (`ORIN`)**, considerando que o **CNPJ de origem seja de uma filial especÃ­fica** e que o `CardCode` seja sempre `'CLJ001'` (Matriz).

   ---

   ### **ğŸ“Œ Relacionamento com Notas de Entrada (`OPCH`)**
   ```sql
   LEFT JOIN OPCH Z4 
      ON T0."Serial" = Z4."Serial"
      AND (
         (T0."VATRegNum" = '17.642.282/0005-57' AND Z4."CardCode" = 'F001577') OR
         (T0."VATRegNum" = '17.642.282/0007-19' AND Z4."CardCode" = 'F002550') OR
         (T0."VATRegNum" = '17.642.282/0004-76' AND Z4."CardCode" = 'F002085') OR
         (T0."VATRegNum" = '17.642.282/0003-95' AND Z4."CardCode" = 'F002550') 
      )
   ```
   ğŸ“Œ **Relaciona Notas de SaÃ­da (`OINV`) com Notas de Entrada (`OPCH`)** de acordo com regras especÃ­ficas de **CNPJ vs. CardCode**.

   ---

   ## **5ï¸âƒ£ WHERE: Filtros Aplicados**
   ```sql
   WHERE 
      T0."CardCode" = 'CLJ001' --- Cadastro da Matriz
   ```
   ğŸ“Œ Filtra **apenas documentos onde a Matriz (`CLJ001`) seja o fornecedor**.

   ```sql
      ---AND T0."CANCELED" = 'N'
   ```
   ğŸ“Œ Essa linha estÃ¡ comentada (`---`), mas caso seja ativada, **excluiria notas canceladas**.

   ```sql
      AND T2."ID" = 47 -- 47 = UtilizaÃ§Ã£o de Transferencia
   ```
   ğŸ“Œ Considera apenas **notas de transferÃªncia**.

   ```sql
      AND T0."VATRegNum" IN ('17.642.282/0005-57', '17.642.282/0007-19', '17.642.282/0004-76', '17.642.282/0003-95')  
   ```
   ğŸ“Œ Filtra apenas notas originadas **dessas filiais**.

   ---

   ## **6ï¸âƒ£ GROUP BY e ORDER BY**
   ```sql
   GROUP BY 
      T0."DocNum", T0."DocDate", T0."VATRegNum", 
      T2."Usage", T0."Serial", Z4."DocNum",Z5."DocNum", 
      CAST(T0."Header" AS NVARCHAR(255)), CAST(T0."Footer" AS NVARCHAR(255)),
      Z0."U_NAME", D1."SlpName"
   ```
   ğŸ“Œ **Agrupa os dados** por nÃºmero da nota, data, CNPJ, natureza da operaÃ§Ã£o, usuÃ¡rio e vendedor.

   ```sql
   ORDER BY "Total Linha" DESC;
   ```
   ğŸ“Œ **Ordena os resultados** do maior para o menor valor total.

   ---

   ## **ğŸ” Resumo**
   - **Objetivo**: Trazer **notas fiscais de saÃ­da (NS)** com informaÃ§Ãµes sobre **notas de entrada (NE) e devoluÃ§Ãµes de saÃ­da (DS)**.
   - **Regra Principal**: O **CNPJ da nota de saÃ­da deve corresponder a um CardCode especÃ­fico na nota de entrada**.
   - **LEFT JOINs** garantem que a consulta retorne **todas as notas de saÃ­da**, mesmo que **nÃ£o tenham notas de entrada ou devoluÃ§Ã£o associadas**.
   - **Filtros** asseguram que **apenas transferÃªncias entre filiais** sejam exibidas.

   ---

   ## ğŸš€ **O que pode ser otimizado?**
   1. **Remover `CAST(T0."Header" AS NVARCHAR(255))` do `GROUP BY`** caso nÃ£o seja necessÃ¡rio.
   2. **Adicionar Ã­ndice** nas colunas `Serial`, `VATRegNum` e `CardCode` para melhorar performance.
   3. **Remover a clÃ¡usula `GROUP BY`** se a consulta nÃ£o precisar de agregaÃ§Ã£o (`SUM(T3."LineTotal")`).

   ---


ğŸ“ **Estoque**  
ğŸ“„ `C_Itens_Saldo.SQL` - Consulta de saldo de itens  

ğŸ“ **Financeiro** *(Em construÃ§Ã£o)*  

ğŸ“ **Fiscal** *(Em construÃ§Ã£o)*  

ğŸ“ **Vendas**  
ğŸ“„ `C_Ven_NF_Saidas.SQL` - Notas fiscais de saÃ­da  

---

## ğŸ› ï¸ ConvenÃ§Ãµes de NomeaÃ§Ã£o
ğŸ”¹ `C_` - Consultas com possÃ­veis campos de usuÃ¡rios (criadas por usuÃ¡rio, nÃ£o sendo nativas)  
ğŸ”¹ `D_` - Consultas em campos default  
ğŸ”¹ `U_` - Consultas em tabelas de usuÃ¡rio  

---

## ğŸš€ Como Utilizar
1ï¸âƒ£ Clone o repositÃ³rio:  
   ```sh
   git clone https://github.com/guih-henriquee/HANA-SQL.git
   ```
2ï¸âƒ£ Navegue atÃ© a pasta desejada e abra a consulta.
3ï¸âƒ£ Execute no banco SAP HANA e ajuste conforme necessÃ¡rio.

---

## ğŸ¤ ContribuiÃ§Ã£o
Se quiser adicionar ou modificar consultas:
1. FaÃ§a um **fork** do repositÃ³rio.
2. Crie uma nova **branch** com sua alteraÃ§Ã£o.
3. Envie um **pull request** para revisÃ£o.

---

## ğŸ“¬ Contato
Em caso de dÃºvidas ou sugestÃµes, entre em contato com o mantenedor do repositÃ³rio. 

ğŸ—‚ï¸ **Organize. Consulte. Otimize.** ğŸš€
